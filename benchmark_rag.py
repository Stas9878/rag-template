# benchmark_rag.py
import json
import httpx
import asyncio
from typing import Dict, Any

# URL —Å–µ—Ä–≤–∏—Å–∞
API_URL = 'http://127.0.0.1:8000/api/query'

# –°–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –≤—Å–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º
TEST_QUERIES = [
    # –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –∑–∞–∫–æ–Ω ‚Ññ 509-–§–ó (30.12.2020)
    '–ö–∞–∫–æ–π –¥–∞—Ç–æ–π –ø—Ä–∏–Ω—è—Ç –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –∑–∞–∫–æ–Ω ‚Ññ 509-–§–ó?',
    '–ö–∞–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–Ω–µ—Å–µ–Ω—ã –≤ —Å—Ç–∞—Ç—å—é 1 –∑–∞–∫–æ–Ω–∞ ‚Ññ 509-–§–ó?',
    '–ö–æ–≥–¥–∞ –≤—Å—Ç—É–ø–∞–µ—Ç –≤ —Å–∏–ª—É –ø—É–Ω–∫—Ç 8 —Å—Ç–∞—Ç—å–∏ 1 –∑–∞–∫–æ–Ω–∞ ‚Ññ 509-–§–ó?',
    '–ö–∞–∫–∏–µ —ç–∫—Å–ø–µ—Ä—Ç—ã —É–ø–æ–º–∏–Ω–∞—é—Ç—Å—è –≤ –∑–∞–∫–æ–Ω–µ –æ—Ç 30.12.2020?',
    '–ß—Ç–æ —Ç–∞–∫–æ–µ –º–Ω–æ–≥–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä —Å–æ–≥–ª–∞—Å–Ω–æ –∑–∞–∫–æ–Ω—É ‚Ññ 509-–§–ó?',

    # –ü—Ä–∏–∫–∞–∑ –ú–∏–Ω—Å—Ç—Ä–æ—è ‚Ññ 669/–ø—Ä (18.09.2023)
    '–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø—Ä–µ–¥—ä—è–≤–ª—è—é—Ç—Å—è –∫ –ì–ò–° –ñ–ö–• —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∏–∫–∞–∑—É ‚Ññ 669/–ø—Ä?',
    '–ö—Ç–æ —É—Ç–≤–µ—Ä–¥–∏–ª –ø—Ä–∏–∫–∞–∑ –ú–∏–Ω—Å—Ç—Ä–æ—è –æ—Ç 18.09.2023 ‚Ññ 669/–ø—Ä?',
    '–ö–∞–∫–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ì–ò–° –ñ–ö–• —É–∫–∞–∑–∞–Ω—ã –≤ –ø—Ä–∏–∫–∞–∑–µ?',

    # –ü—Ä–∏–∫–∞–∑ –ú–∏–Ω—Å—Ç—Ä–æ—è ‚Ññ 259/–ø—Ä (28.04.2025)
    '–ö–∞–∫–∏–µ —Ñ–æ—Ä–º—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã –ø—Ä–∏–∫–∞–∑–æ–º –æ—Ç 28.04.2025 ‚Ññ 259/–ø—Ä?',
    '–ö–∞–∫–∏–µ —Å—Ä–æ–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–∫–∞–∑—É ‚Ññ 259/–ø—Ä?',

    # –ü—Ä–∏–∫–∞–∑ –ú–∏–Ω—Å—Ç—Ä–æ—è ‚Ññ 266/–ø—Ä (30.04.2025)
    '–ö–∞–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∏–∫–∞–∑–æ–º –æ—Ç 30.04.2025 ‚Ññ 266/–ø—Ä?',
    '–ö–∞–∫–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –æ–±—è–∑–∞–Ω—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∏–∫–∞–∑—É ‚Ññ 266/–ø—Ä?'
]

async def send_query(client: httpx.AsyncClient, query: str) -> Dict[str, Any]:
    try:
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–æ 60 —Å–µ–∫—É–Ω–¥
        response = await client.get(
            API_URL,
            params={'query': query},
            timeout=60.0
        )
        response.raise_for_status()
        data = response.json()
        return {
            'query': query,
            'answer': data.get('answer'),
            'results': data.get('results', []),
            'metrics': data.get('metrics', {})
        }
    except Exception as e:
        error_msg = f'{type(e).__name__}: {str(e)}'
        print(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ \'{query}\': {error_msg}')
        return {
            'query': query,
            'answer': None,
            'results': [],
            'metrics': {},
            'error': error_msg
        }

async def main():
    # –£–º–µ–Ω—å—à–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –¥–æ 1 –∑–∞–ø—Ä–æ—Å–∞ –∑–∞ —Ä–∞–∑
    async with httpx.AsyncClient() as client:
        results = []
        for query in TEST_QUERIES:
            result = await send_query(client, query)
            results.append(result)
            # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
            await asyncio.sleep(1)

    with open('rag_benchmark_results.json', 'w', encoding='utf-8') as f:
        json.dump(results, f, ensure_ascii=False, indent=2)

    print(f'‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ rag_benchmark_results.json')
    print(f'üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤: {len(results)}')

if __name__ == '__main__':
    asyncio.run(main())